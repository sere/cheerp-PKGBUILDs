# Maintainer: Yuri Iozzelli <y.iozzelli@gmail.com>
pkgname=cheerp-llvm-clang
pkgver=9.b1905a1
pkgrel=1
epoch=
pkgdesc="A C++ compiler for the Web"
arch=("x86_64")
url="leaningtech.com/cheerp"
license=('custom')
groups=()
depends=("python" "gcc-libs")
makedepends=("cmake")
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
source=("cheerp-llvm::git+ssh://git@bitbucket.org/apignotti/cheerp-llvm.git"
"clang::git+ssh://git@bitbucket.org/apignotti/cheerp-clang.git")
md5sums=('SKIP'
         'SKIP')

pkgver() {
  cd "$_pkgname"
  echo $(git rev-list --count HEAD).$(git rev-parse --short HEAD)
}

prepare() {
	cd $srcdir
	mv  -n clang cheerp-llvm/tools/
	cd $srcdir/cheerp-llvm
	rm -rf build
	mkdir build
	cd build
	cmake -DCMAKE_INSTALL_PREFIX=/opt/cheerp \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_C_FLAGS_RELWITHDEBINFO="-O2 -g" \
		-DCMAKE_CXX_FLAGS_RELWITHDEBINFO="-O2 -g" \
		-GNinja \
		-DCMAKE_C_COMPILER=/opt/cheerp/bin/clang \
		-DCMAKE_CXX_COMPILER=/opt/cheerp/bin/clang++ \
		-DLLVM_TARGETS_TO_BUILD="CheerpBackend;X86" ..
		#-DCMAKE_EXE_LINKER_FLAGS=-fuse-ld=lld \
		#-DCMAKE_SHARED_LINKER_FLAGS=-fuse-ld=lld \
		#-DCMAKE_C_COMPILER=/opt/cheerp/bin/clang \
		#-DCMAKE_CXX_COMPILER=/opt/cheerp/bin/clang++ \
}

build() {
	cd $srcdir/cheerp-llvm/build
	ninja
}

package() {
	cd $srcdir/cheerp-llvm/build
	DESTDIR=$pkgdir ninja install
	mkdir -p $pkgdir/usr/bin

	cat <<EOF > $pkgdir/usr/bin/cheerp-clang
#!/bin/bash
/opt/cheerp/bin/clang \$@
EOF
	chmod a+x $pkgdir/usr/bin/cheerp-clang
	cat <<EOF > $pkgdir/usr/bin/cheerp-clang++
#!/bin/bash
/opt/cheerp/bin/clang++ \$@
EOF
	chmod a+x $pkgdir/usr/bin/cheerp-clang++

	mkdir -p $pkgdir/usr/share/licenses/cheerp-llvm-clang
	cp $srcdir/cheerp-llvm/LICENSE.TXT $pkgdir/usr/share/licenses/cheerp-llvm-clang
}
